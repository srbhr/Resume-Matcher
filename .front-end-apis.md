# Frontend API Contract

This document defines the API contract between the Next.js frontend and the FastAPI backend for the Resume Matcher application.

## Overview

The API supports the following workflows:
1.  **Initialize**: Uploading a base "Master Resume" (PDF/DOCX).
2.  **View**: Fetching resume data for display.
3.  **Tailor**: Uploading a target Job Description (JD).
4.  **Improve**: Generating a tailored resume based on the Master Resume + Job Description.
5.  **Configure**: Managing LLM provider settings and viewing system status.

## API Endpoints

### 1. Upload Master Resume

Uploads a raw resume file (PDF or DOCX), converts it to Markdown, and stores it.

-   **Endpoint**: `POST /api/v1/resumes/upload`
-   **Content-Type**: `multipart/form-data`
-   **Request Body**:
    -   `file`: The resume file (PDF or DOCX, max 2MB).
-   **Response (200 OK)**:
    ```json
    {
      "message": "File <filename> successfully processed as MD and stored in the DB",
      "request_id": "uuid-string",
      "resume_id": "uuid-string"
    }
    ```
-   **Errors**:
    -   `400 Bad Request`: Invalid file type or empty file.
    -   `413 Payload Too Large`: File exceeds 2MB.
    -   `422 Unprocessable Entity`: Validation failure.

### 2. Fetch Resume Details

Retrieves the structured data for a specific resume (Master or Tailored). Used by the Viewer and Builder.

-   **Endpoint**: `GET /api/v1/resumes`
-   **Query Parameters**:
    -   `resume_id`: The UUID of the resume to fetch.
-   **Response (200 OK)**:
    ```json
    {
      "request_id": "uuid-string",
      "data": {
        "resume_id": "uuid-string",
        "raw_resume": {
          "id": 123,
          "content": "string (JSON stringified or Markdown text)",
          "content_type": "md",
          "created_at": "ISO-8601-timestamp"
        },
        "processed_resume": {
           "personalInfo": {
             "name": "string",
             "title": "string",
             "email": "string",
             "phone": "string",
             "location": "string",
             "website": "string | null",
             "linkedin": "string | null",
             "github": "string | null"
           },
           "summary": "string",
           "workExperience": [
             {
               "id": 1,
               "title": "string (job title)",
               "company": "string",
               "location": "string | null",
               "years": "string (e.g., '2020 - Present')",
               "description": ["string (bullet points)"]
             }
           ],
           "education": [
             {
               "id": 1,
               "institution": "string",
               "degree": "string",
               "years": "string",
               "description": "string | null"
             }
           ],
           "personalProjects": [
             {
               "id": 1,
               "name": "string",
               "role": "string",
               "years": "string",
               "description": ["string"]
             }
           ],
           "additional": {
             "technicalSkills": ["string"],
             "languages": ["string"],
             "certificationsTraining": ["string"],
             "awards": ["string"]
           }
        }
      }
    }
    ```
    *Note: `processed_resume` may be null if the resume hasn't been parsed/structured yet.*

-   **Errors**:
    -   `400 Bad Request`: Missing `resume_id`.
    -   `404 Not Found`: Resume ID does not exist.

### 3. Upload Job Description

Stores a raw text job description to be used for tailoring.

-   **Endpoint**: `POST /api/v1/jobs/upload`
-   **Content-Type**: `application/json`
-   **Request Body**:
    ```json
    {
      "job_descriptions": ["Raw text of the job description..."],
      "resume_id": "uuid-string (optional linkage)"
    }
    ```
-   **Response (200 OK)**:
    ```json
    {
      "message": "data successfully processed",
      "job_id": ["uuid-string"],
      "request": { ... }
    }
    ```
    *Note: Returns an array of job_ids corresponding to the input array.*

-   **Errors**:
    -   `400 Bad Request`: Invalid payload or missing fields.

### 4. Improve / Tailor Resume

Triggers the AI agent to optimize the Master Resume against the Job Description.

-   **Endpoint**: `POST /api/v1/resumes/improve`
-   **Content-Type**: `application/json`
-   **Request Body**:
    ```json
    {
      "resume_id": "uuid-string (Master Resume ID)",
      "job_id": "uuid-string (Job ID from step 3)"
    }
    ```
-   **Response (200 OK)**:
    ```json
    {
      "request_id": "uuid-string",
      "data": {
        "request_id": "uuid-string",
        "resume_id": "uuid-string (ID of the NEW tailored resume)",
        "job_id": "uuid-string",
        "original_score": 75,
        "new_score": 95,
        "resume_preview": {
            // Full structured resume object matching the Builder's data shape
            "personalInfo": { ... },
            "workExperience": [ ... ],
            // ...
        },
        "improvements": [
            { "suggestion": "...", "lineNumber": 10 }
        ]
      }
    }
    ```
-   **Errors**:
    -   `500 Internal Server Error`: AI processing failure or database error.
    -   `422 Unprocessable Entity`: Keyword extraction failed.

### 5. Get System Status

Returns comprehensive system health and database statistics.

-   **Endpoint**: `GET /api/v1/status`
-   **Response (200 OK)**:
    ```json
    {
      "status": "ready | setup_required",
      "llm_configured": true,
      "llm_healthy": true,
      "has_master_resume": true,
      "database_stats": {
        "total_resumes": 5,
        "total_jobs": 3,
        "total_improvements": 2,
        "has_master_resume": true
      }
    }
    ```

### 6. Get LLM Configuration

Retrieves current LLM provider configuration (API key is masked).

-   **Endpoint**: `GET /api/v1/config/llm-api-key`
-   **Response (200 OK)**:
    ```json
    {
      "provider": "openai",
      "model": "gpt-4o-mini",
      "api_key": "sk-...xxxx",
      "api_base": null
    }
    ```

### 7. Update LLM Configuration

Updates LLM provider settings. Validates the configuration before saving.

-   **Endpoint**: `PUT /api/v1/config/llm-api-key`
-   **Content-Type**: `application/json`
-   **Request Body**:
    ```json
    {
      "provider": "openai | anthropic | openrouter | gemini | deepseek | ollama",
      "model": "gpt-4o-mini",
      "api_key": "sk-...",
      "api_base": "http://localhost:11434 (optional, for Ollama)"
    }
    ```
    *Note: All fields are optional. Only provided fields are updated.*
-   **Response (200 OK)**:
    ```json
    {
      "provider": "openai",
      "model": "gpt-4o-mini",
      "api_key": "sk-...xxxx",
      "api_base": null
    }
    ```
-   **Errors**:
    -   `400 Bad Request`: Invalid configuration (e.g., bad API key).

### 8. Test LLM Connection

Tests the current LLM configuration by making a minimal API call.

-   **Endpoint**: `POST /api/v1/config/llm-test`
-   **Response (200 OK)**:
    ```json
    {
      "healthy": true,
      "provider": "openai",
      "model": "gpt-4o-mini",
      "response_model": "gpt-4o-mini-2024-07-18"
    }
    ```
-   **Response (200 OK - Unhealthy)**:
    ```json
    {
      "healthy": false,
      "provider": "openai",
      "model": "gpt-4o-mini",
      "error": "Invalid API key"
    }
    ```

## Supported LLM Providers

| Provider | Model Format | Requires API Key |
|----------|--------------|------------------|
| `openai` | `gpt-4o-mini`, `gpt-4o` | Yes |
| `anthropic` | `claude-3-5-sonnet-20241022` | Yes |
| `openrouter` | `anthropic/claude-3.5-sonnet` | Yes |
| `gemini` | `gemini-1.5-flash` | Yes |
| `deepseek` | `deepseek-chat` | Yes |
| `ollama` | `llama3.2`, `mistral` | No (local) |

## Data Flow Diagram

```mermaid
sequenceDiagram
    participant U as User (Frontend)
    participant A as API (Backend)
    participant D as Database
    participant L as LLM Agent

    Note over U, L: 0. Configuration
    U->>A: GET /status
    A-->>U: Return system health & stats
    U->>A: PUT /config/llm-api-key
    A->>L: Validate credentials
    A-->>U: Return updated config

    Note over U, L: 1. Initialization
    U->>A: POST /resumes/upload (PDF/DOCX)
    A->>D: Store Raw Resume
    A-->>U: Return resume_id (Master)

    Note over U, L: 2. Tailoring
    U->>A: POST /jobs/upload (JD Text)
    A->>D: Store Job Description
    A-->>U: Return job_id

    U->>A: POST /resumes/improve (master_id, job_id)
    A->>D: Fetch Master Resume & JD
    A->>L: Optimize Resume
    L-->>A: Return Improved JSON
    A->>D: Store New Resume (Tailored)
    A-->>U: Return new_resume_id & Preview Data

    Note over U, L: 3. Viewing/Editing
    U->>A: GET /resumes?resume_id=new_resume_id
    A->>D: Fetch Resume Data
    A-->>U: Return Structured JSON
```

